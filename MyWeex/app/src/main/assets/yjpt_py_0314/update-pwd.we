<template>
    <wxc-navpage data-role="none" height={{navBarHeight}} background-color="#00cc99" title="修改密码" title-color="white"  onclickleftitem="onclickleftitem" left-item-src="{{headLeft}}">
            <div class="login_row">
                <div class="row_right">
                    <div class="login_icon">
                        <image class="row_img2" src="{{pwdImg}}"></image>
                    </div>
                    <input class="row_inpt" type="password" placeholder="请输入旧密码" value="{{oldPwd}}" oninput="jPwdIn"></input>
                </div>
            </div>
            <div class="login_row">
                <div class="row_right">
                    <div class="login_icon">
                        <image class="row_img2" src="{{pwdImg}}"></image>
                    </div>
                    <input class="row_inpt" type="password" placeholder="请输入新密码" value="{{pwd}}" oninput="pwdIn"></input>
                </div>
            </div>
            <div class="login_row">
                <div class="row_right">
                    <div class="login_icon">
                        <image class="row_img2" src="{{pwdImg}}"></image>
                    </div>
                    <input class="row_inpt" type="password" placeholder="请确认新密码" value="{{pwd2}}" oninput="pwdDouble"></input>
                </div>
            </div>
            <div class="login_row">
                <text class="login_btn" onclick="openPage" >确定</text>
            </div>  
    </wxc-navpage>
</template>
<style>
    .login_wrap{margin:20;}
    .login_row{flex-direction: row;align-items: center;margin:30; margin-bottom: 10;}
    .row_right{flex: 1;position: relative;flex-direction: row;align-items: center;}
    .row_inpt{height: 84; padding-left:100;font-size: 34;color: #666666;font-family: Microsoft YaHei;border-width: 1; border-color: #00cc99; border-radius: 8; border-bottom-right-radius: 8; position: relative;z-index: 0;flex: 1;}    
    .login_icon{position: absolute;left: 0;top: 0;z-index: 20;width: 80;height: 84;background-color: #dff0d8;  border-bottom-left-radius: 8; border-right-width: 1; border-right-color: #00cc99; display: flex; align-items: center; border-top-left-radius: 8;}
    .row_img2{width: 30;height: 30;margin-top: 26;}
    .login_btn{padding: 25; text-align: center; color: #ffffff; border-radius: 8; background-color: #00cc99; flex:1; font-family: Microsoft YaHei; font-size: 36; }
</style>

<script>
    require('weex-components');
    var Utils = require('./javascript/Utils');
    var modal = require('@weex-module/modal');
    var storage = require('@weex-module/storage');
    module.exports = {
        data: {
            navBarHeight:130,
            dir: 'yjpt',
           // url:'',
            oldPwd:'',
            pwd:'',
            pwd2:'',
            verCode:'',
            phoneNumCheck:false,
            pwdCheck:false, 
            oldPwdCheck:false,
            pwdDoubleCheck:false ,
            userId:'',
        },
        created : function(){
            var self = this;
            this.headLeft = Utils.ip + 'yjpt/images/id_right_bg.png';
            this.phoneImg = Utils.ip + 'yjpt/images/phone.png';
            this.qrImg = Utils.ip + 'yjpt/images/ewm.png';
            this.pwdImg = Utils.ip + 'yjpt/images/pwd.png';
            this.$on('naviBar.leftItem.click',function(e){ 
                // history.back();
                Utils.navigate.pop(this,'true');
            }); 

            storage.getItem('userId',function(e){
                if(e.data != 'undefined'){
                    self.userId = e.data;
                }
            })
        },
        methods:{
           /* redirect:function(url){
              //  Utils.navigate.push(this,url,'true');
              this.$openURL(Utils.setOpenUrl(this.$getConfig(),'name'));
            },*/
            jPwdIn :function(e){
                var self = this;
                self.oldPwd=e.value;

                var Pwd;
                storage.getItem('Pwd',function(e){
                    Pwd=e.data;
                   if(/\S{6,}/.test(self.oldPwd) == Pwd){
                        self.oldPwdCheck=true;
                        console.log("旧密码"+self.oldPwdCheck);
                     }else{
                        self.oldPwdCheck=false;
                     } 
                }); 
            },
            pwdIn :function(e){
                var self = this;
                self.pwd=e.value;
                self.pwdCheck=/\S{6,}/.test(self.pwd) ? true : false;
                console.log("新密码"+self.pwdCheck);
            },
            pwdDouble : function(e){
                var self = this;
                self.pwd2=e.value;
                if(/\S{6,}/.test(self.pwd2) && self.pwd2 == self.pwd){
                    self.pwdDoubleCheck=true;
                    console.log("确认密码"+ self.pwdDoubleCheck);
                }else{
                    self.pwdDoubleCheck=false;
                }
            },
             /*==================修改密码====================*/
            openPage : function(){
                var self = this;
                if(self.pwdCheck==false){
                    modal.alert({
                        message:'请输入至少6位以上密码',
                        okTitle:'好的'
                    },function(){});
                    return;
                }
                if(self.pwdCheck==false){
                    modal.alert({
                        message:'请输入至少6位以上密码',
                        okTitle:'好的'
                    },function(){});
                    return;
                }
                if(self.pwdDoubleCheck==false){
                    modal.alert({
                        message:'两次输入的密码不一致',
                    },function(){});
                    return;
                }

                
                Utils.fetch({
                url:'/app/user/password',
                data:'oldPassword='+self.oldPwd+'&newPassword='+self.pwd+'&userId='+self.userId,
                method:'put',
                dataType:'json',
                success:function(ret){
                    if(ret.data.StatusCode=='200'){
                        modal.toast({
                            message:'密码修改成功，请重新登录',
                            duration:'1'
                        });
                        setTimeout(function(){
                            //self.$openURL(self.url);
                            //self.$openURL(Utils.setOpenUrl(self.$getConfig(),'login'));
                            var url=Utils.setOpenUrl(self.$getConfig(),'login');
                            Utils.navigate.push(self,url,'true'); 
                        },600);
                    }else{
                        modal.toast({
                            message:'修改失败错误，请稍后重试',
                            duration:'1'
                        });
                    }
                }

                })
               
               
             }
        }
    }
</script>

