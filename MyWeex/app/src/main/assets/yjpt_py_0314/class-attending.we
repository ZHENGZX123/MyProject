<template>
    <wxc-navpage data-role="none" height={{navBarHeight}} background-color="#00cc99" title="{{pageTitle}}" title-color="white" onclickleftitem="onclickleftitem" left-item-src="{{leftItemImg}}">
        <scroller class="content">   
            <div class="wxts">
                <text class="tips_txt">温馨提示：</text>
                <text class="tips_txt">1：请先确保与盒子在同个wifi环境下。</text>
                <text class="tips_txt">2：请确保盒子的资源与所要上课的班级对应。</text>
                <text class="tips_txt">3：换取卡资源后，如盒子上方显示资源不对时,请重启盒子</text>
            </div>         
            <div class="item"  repeat="myClass" > <!--onclick="redirect(url,id)"-->
                <div class="list" style="flex:3;">
                    <text class="className" >{{name}}</text><text class="item_txt">（{{gradeId}}）</text><text class="invite_Code" if="{{mac}}">{{mac}}</text> <!--已绑定才显示-->

                </div>
                <div class="list">
                    <text class="items_btn" if="{{mac}}" onclick="redirect(url,id)">点击上课</text>
                    <text class="items_btn btn_no" if="{{!mac}}" onclick='scanToClass(id)'>扫码上课</text>
                </div> 
            </div>
            <!-- <div class="item" onclick="redirect(url)">
                <div class="list" style=" flex:3; ">
                    <text class="className" >红太阳一班</text>
                    <text class="item_txt">中班</text>
                    <text class="invite_Code" >未绑定</text>
                </div>
                <div class="list">
                    <text class="items_btn btn_no" >扫码上课</text>                   
                </div> 
            </div>   -->
        </scroller>
    </wxc-navpage>  
</template>
<style>
    .title{text-align: center;margin:20;margin-top: 70;font-size: 36;}
    .content{background: #fff;color: #333;font-family: Microsoft YaHei;}
    .wxts{ lines:2;   background-color: #f4f1f1;padding: 20;}
    .item {
        width: 750;  background-color:#fff;
        border-bottom-width: 1;
        border-bottom-color: #e7e7e7;
        border-bottom-style: solid;
        padding:35;
        flex-direction: row;
        display: flex; align-items: center; justify-content:space-between;
    }
    .tips_txt{color: #00cc99;}
    .list{flex-direction: row; display: flex; align-items:center;justify-content:space-around;}
    .className{ font-size: 36; }
    .invite_Code{font-size: 30; color: #444; text-align: center; flex:1; }
    .item_txt{margin-left: 5;margin-right: 15;font-size: 30; color: #444; word-wrap: break-word;word-break: break-all;}
    .items_btn{border-radius: 4; background-color: #0c9;color: #fff; padding: 15;padding-top: 12; padding-bottom: 12; text-align: center;font-size: 32;}
    .btn_no{background-color: #e7e7e7;}
</style>
<script>
  require('weex-components');
  var Utils = require('./javascript/Utils');
  var modal = require('@weex-module/modal');
  var storage = require('@weex-module/storage');
  var event = require('@weex-module/event');
  // var actionQRScan = require('@weex-module/event');
  module.exports = {
      data: {
          navBarHeight: 130,
          dir:'yjpt',
          fontsUrl:'',
          leftItemImg:'yjpt/images/id_right_bg.png',
         // url:'class-calendar.js',
          classList:[],
          pageTitle:'连接盒子',
          myClass:[],  
          baseData:[],
          gradeList:[] 
      },
      created : function(){
          this.$on('naviBar.leftItem.click',function(e){ 
              Utils.navigate.pop(this,'true');
          });
          
          // this.url = Utils.setOpenUrl(this.$getConfig(),this.url);
          this.leftItemImg = Utils.changeImg(this.leftItemImg);     

          var self = this;

          // storage.getItem('myClass',function(e){
          //     if(e.data){
          //         self.myClass = JSON.parse(e.data);                  

          //         storage.getItem('baseData',function(e){
          //             if(e.data != 'undefined'){
          //                 self.baseData = JSON.parse(e.data);
          //                 self.gradeList = self.baseData.gradeList;

          //                 for(var i in self.myClass){
          //                     for(var j in self.gradeList){                             
          //                         if(self.myClass[i].gradeId == self.gradeList[j].id){
          //                             self.myClass[i].gradeId = self.gradeList[j].name;
          //                         }
          //                     }
          //                 }
          //             }
          //         }); 
          //     }
          // });            
   
          Utils.fetch({
              url:'/app/class',
              method:'get',
              dataType:'json',
              success:function(res){
                  if(res.data.StatusCode == '200'){
                      self.myClass = res.data.data; 
                      storage.getItem('baseData',function(e){
                          if(e.data != 'undefined'){
                              self.baseData = JSON.parse(e.data);
                              self.gradeList = self.baseData.gradeList;

                              for(var i in self.myClass){
                                  for(var j in self.gradeList){                             
                                      if(self.myClass[i].gradeId == self.gradeList[j].id){
                                          self.myClass[i].gradeId = self.gradeList[j].name;
                                      }
                                  }
                              }
                          }
                      }); 
                  }
              }
          });  

      },
      methods:{
          redirect:function(url,classId){
              var self = this;

              storage.setItem('classId',classId,function(){});

              if(event.teachClass){
                  event.teachClass(classId,function(res){
                      if(res.result == '1'){
                          var url = Utils.setOpenUrl(self.$getConfig(),'class-calendar');
                          Utils.navigate.push(self,url,'true');   
                      }else{
                          modal.toast({
                              message:'请链接至盒子wifi',
                              duration:'2'
                          });
                      }
                  });
              }

              

          },
          scanToClass(classId){
              var self = this;
              storage.setItem('classId',classId,function(){});
              
              if(event.QRScan ){
                  event.QRScan({
                      classId:classId
                  },function(res){
                      //返回盒子信息，再绑定盒子
                      if(res.result == '1'){
                          var ssid = res.ssid;
                          storage.setItem("SSID",ssid,function(){});

                          Utils.fetch({
                              url:'/app/class/'+classId+'/box',
                              data:'mac=' + res.hCode,
                              method:'POST',
                              dataType:'json',
                              success:function(ret){
                                  if(ret.data.StatusCode == '200'){
                                      // modal.toast({
                                      //     message:'绑定成功'
                                      // });
                                      event.teachClass(classId,function(ret){                                         
                                          if(ret.result == '1'){
                                              //跳转到上课页面
                                              var url = Utils.setOpenUrl(self.$getConfig(),'class-calendar');
                                              Utils.navigate.push(self,url,'true');
                                          }else{
                                              modal.toast({
                                                  message:'请链接至盒子wifi',
                                                  duration:'2'
                                              });
                                          }
                                      });

                                         
                                  }else{
                                      modal.toast({
                                          message:'绑定失败，请稍后重试'
                                      });
                                  }
                              }
                          });
                      }
                  });
              }else{
                  modal.toast({
                      message:'请在手机App中操作'
                  });
              }
          }
      }
  };
</script>
