<template>
    <wxc-navpage data-role="none" height={{navBarHeight}} background-color="#00cc99" title="加入班级" title-color="white" onclickleftitem="onclickleftitem" left-item-src="{{images.leftItemImg}}">
        <div class="create_wrap">
            <div class="create_col" if='isJoinClass=="no"' onclick="chooseCity">
                <text class="school_type">地区</text>
                <div class='school_wrap'>
                    <text class='school_name'>{{countryId}}</text>
                </div>
            </div>

            <div class="create_col" onclick="chooseSchool" if='isJoinClass=="no"'> 
                <text class="school_type">{{schoolData.schoolType}}</text>
                <div class='school_wrap'>
                    <text class='school_name'>{{schoolData.schoolName}}</text>
                </div>
            </div>

            <div class="create_col" onclick="chooseClass" style="z-index: 99999;position: relative;">
                <text class="school_type">{{classInfo.name}}</text>
                <div class='school_wrap'>
                    <!-- <text class="school_name">{{class.join(',')}} &nbsp;</text> -->
                    <!-- <text class="school_name" repeat="{{class}}" style="text-align:right;" if="{{$index < (class.length-1)}}">{{class[$index]}}， &nbsp;</text> -->
                    <text class="school_name" style="text-align:right;">{{class.join(',')}} &nbsp;</text>
                </div>
            </div>

            <div style="margin-bottom: 30;" if='isJoinClass=="no"'>
                <input class='name_input'
                    type="url"
                    value="{{schoolCode}}" placeholder="请输入邀请码" oninput="schoolCodeIn">
                </input>
            </div> 
            <text  class="next_step" onclick="nextStep">下一步</text>
            <class-list-data if="{{showClass==1}}" style="z-index: 999999;"></class-list-data>
        </div>
        <wxc-citypicker class="city_picker" if="{{isShowCity}}"></wxc-citypicker>

        <!--学校列表-->
        <div class="school_list" if="{{isShowSchools==1}}">
            <div class="schools"  repeat='schoolList' onclick="radioCheck($index)"  id="sb$index">
                <text class="school_name" style="text-align: left;">{{name}}</text>
                <image class="blank_img" if="{{isCheck}}" src='{{images.selectRadio}}'></image>
                <image class="blank_img" if="{{!isCheck}}" src='{{images.blankRadio}}'></image>
            </div>
        </div>
</wxc-navpage>  
</template>
<style>
   .create_wrap{flex: 1;padding-top: 20;position: relative;z-index: 999;}
   .create_col{background-color: #ebebeb;padding: 35;margin-bottom: 20;flex-direction: row;align-items: center;position: relative;z-index: 888;border-bottom-style: solid;border-bottom-color: #dddddd;border-bottom-width: 1;}
   .school_type{flex: 1;font-size: 34;}
   .school_name{font-size: 34;text-align: right;}
   .class_name{font-size: 34;}
   .school_wrap{flex-direction: row;flex: 3;}
   .arrow_right{width:19;height: 32;margin-left: 15;margin-right: 10;}
   .inpt{height: 80;border-width: 1;border-color: #ccc;padding: 20;font-size: 30;margin-top: 20;border-radius: 4;}
   .col{padding: 20;}
   .next_step{background-color: #ff9e6a;color: #fff;border-radius: 4;text-align: center;font-size: 34;margin:20;padding: 30;position: relative;z-index: 999;}
   .select{flex: 1;font-size: 34;}
   .select_options{position: fixed;left: 0;top: 0;right: 0;bottom: 0;background-color: rgba(0,0,0,.7);align-items: flex-end;display: flex;flex: 1;flex-direction: row;justify-content:center;}
   .options_box{background-color: #fff;flex: 1;text-align: center;}
   .options{border-bottom-width: 1;border-bottom-color: #ddd;border-bottom-style:solid;text-align: center;padding: 20;}


    .create_col{background-color: #ebebeb;padding: 30;margin-bottom: 30;flex-direction: row;align-items: center;position: relative;}
    .select_options{position: fixed;left: 0;top: 0;right: 0;bottom: 0;background-color: rgba(0,0,0,.7);align-items: flex-end;display: flex;flex: 1;flex-direction: row;justify-content:center;}
    .options_box{background-color: #fff;flex: 1;text-align: center;}
    .options{border-bottom-width: 1;border-bottom-color: #ddd;border-bottom-style:solid;text-align: center;padding: 30;font-size: 34;}
    .arrow_right{width: 19;height: 32;}

     .school_list{position: fixed;z-index: 99999;left: 0;top:130;right: 0;bottom: 0;background-color: #ffffff;}
     .schools{flex-direction: row;padding: 30;align-items: center;background: #fff;border-bottom-width:1;border-bottom-style:solid;border-bottom-color:#ddd;padding-top: 40;padding-bottom: 40;font-size: 34;}
    ./*gender_select*/{width: 1270;height: 35;text-align: right;}
    .blank_img{height: 40;width: 40;}
    .school_name{flex: 4;font-size: 34;}

    .btnGray{background-color: #d2c7c1;color: #fff;border-radius: 4;text-align: center;font-size: 34;margin:20;padding: 30;}

    .name_input{flex:3;border-width: 1;border-color: #dddddd;height: 100;line-height: 100;padding-left: 20;font-size: 34;background-color: #ffffff;border-left-style: none;border-right-style: none;color:#000000;}
</style>
<script>
    require('weex-components');
    var Utils = require('./javascript/Utils');
    var storage = require('@weex-module/storage');
    var modal = require('@weex-module/modal');
    module.exports = {
        data: {
            loading:false,   
            navBarHeight: 130,
            showClass:0,
            selectedClass:'未选择班级',
            selectedGrade:'',
            dir:'yjpt',
            isGray:true,
            schoolCode:'',
            images:{
                leftItemImg:'yjpt/images/id_right_bg.png',
                qrImg:'yjpt/images/qr_img.png',
                arrowRight:'yjpt/images/arrow_right2.png',
                blankRadio:'yjpt/images/blank_radio2.png',
                selectRadio:'yjpt/images/select_radio2.png'
            },     
            images2:{
                blankRadio:'yjpt/images/checkbox_blank.png',
                selectRadio:'yjpt/images/checkbox_checked.png'
            },       
            schoolData:{
                userId:'',
                schoolId:'',
                schoolType:'幼儿园',
                schoolName:'请选择学校',
                gradeId:'1',
                className:''
            },
            allChecked:'',
            multiList:[
               {name:'选项1',imgUrl:''},
               {name:'选项2',imgUrl:''},
               {name:'选项3',imgUrl:''}
            ],
            classList:[

            ],
            url:'class-main-page',
            loginUrl:'login',
            schoolsList:'schools-list',
            regionList:'region-list',
            indexUrl:'index',
            selectedValue:'小班',
            isShow:false,
            selectOptions:[
                {classType:'小班'},
                {classType:'中班'},
                {classType:'大班'},
                {classType:'大大班'},
            ],
            countryId:'请选择地区',
            doneLoad:false,
            address:'',
            isShowCity:false,
            isShowSchools:0,
            hasLoaction:false,
            location:'',
            schoolList:[],
            isCityEmpty:false,
            schoolAddress:'',
            classIds:[],
            class:['请选择班级'],
            classCopy:'请选择班级',
            isJoinClass:'no',
            joinedClass:[],
            classInfo:{
                name:'班级',
                classSelected:[]
            },
            userPhone:'',
            userClassList:[],
            myClass:[],
        },
        created:function(){

            Utils.changeImg(this.images,['leftItemImg','qrImg','arrowRight','blankRadio','selectRadio']);
            Utils.changeImg(this.images2,['blankRadio','selectRadio']);
            this.$on('naviBar.leftItem.click',function(e){ 
                Utils.navigate.pop(this,'true');
            });

            var bundleUrl = this.$getConfig().bundleUrl;
            var nativeBase;
            var isAndroidAssets = bundleUrl.indexOf('file://assets/') >= 0;
            var isiOSAssets = bundleUrl.indexOf('file:///') >= 0 ;
            if (isAndroidAssets) {
              nativeBase = 'file://assets/yjpt/weex/';
            }
            else if (isiOSAssets) {
                nativeBase = bundleUrl.substring(0, bundleUrl.lastIndexOf('/') + 1);
            }
            else {
                var host = 'localhost:12580';
                var matches = /\/\/([^\/]+?)\//.exec(this.$getConfig().bundleUrl);
                if (matches && matches.length >= 2) {
                    host = matches[1];
                }
                nativeBase = 'http://' + host + '/' + this.dir + '/weex_jzd/';
            }
            var h5Base = './index.html?page=./' + this.dir + '/weex_jzd/';
            // in Native
            var base = nativeBase;
            if (typeof window === 'object') {
                // in Browser or WebView
                base = h5Base;
            }
            
            this.url = base + this.url + '.js';
            this.schoolsList = base + this.schoolsList + '.js';
            this.loginUrl = base + this.loginUrl + '.js';
            this.regionList = base + this.regionList + '.js';
            this.indexUrl = base + this.indexUrl + '.js';

            

            var self = this;            
            self.classCopy = self.class.join(',');  

            self.$on('showClass', function(e) {                
                self.showClass = e.detail;                
            });                        
            
            self.$on('classNames', function(e) {
                if(e.detail){
                    console.log(e.detail);
                    self.class = [];
                    self.classCopy = '';
                    for(var i in e.detail){
                        self.class.push(e.detail[i]);
                    }

                    var tmpArr = [];
                     for(var i=0; i<self.class.length; i++){
                      //如果当前数组的第i已经保存进了临时数组，那么跳过，
                      //否则把当前项push到临时数组里面
                      if(tmpArr.indexOf(self.class[i].name) == -1){
                       tmpArr.push(self.class[i].name);
                      }
                     }

                     self.class = tmpArr;                     
                    // self.class = self.class.join(',');                    
                    self.classInfo.classSelected = e.detail;
                }else{
                    self.classCopy = '请选择班级';
                }
                    
            }); 



            //该用户下有班级时，不需要输入邀请码
            storage.getItem('userInfo',function(e){
                if(e.data){
                    e.data = JSON.parse(e.data);
                    self.userPhone = e.data.mobile;
                    if(e.data.region){
                        self.countryId = e.data.region;
                    }
                    
                    if(self.userPhone){
                        Utils.fetch({
                            url:'/app/class/phone/'+self.userPhone,
                            data:'',
                            method:'get',
                            dataType:'json',
                            success:function(ret){
                                if(ret.data.StatusCode == '200'){
                                    self.userClassList = ret.data.data;
                                }
                            }
                        });
                    }
                }
            });

            storage.getItem('isJoinClass',function(e){
                self.isJoinClass = e.data;
                if(self.isJoinClass == 'yes'){
                    storage.getItem('mySchoolId',function(s){
                        self.schoolData.schoolId = s.data;
                    })
                    storage.getItem('myClass',function(myClass){
                        if(myClass.data){
                            self.myClass = JSON.parse(myClass.data);
                        }
                    })
                }                
            });


            // Utils.fetch({
            //     url:'/app/class/unbind/37',//[school:128,class:[39,37,68]]
            //     method:'delete',
            //     dataType:'json',
            //     success:function(){}
            // });

            
        },
        methods:{
            redirect:function(url){                
                Utils.navigate.push(this,url,'true'); 
            },
            toggleSelect:function(){
                this.isShow = !this.isShow;
            },                      
            optionsSelect:function(index){
                this.selectedValue = this.$el("options_"+index).attr.value;
                this.isShow = !this.isShow;

                if(this.selectedValue == '小班'){
                    this.schoolData.gradeId = '4';
                }else if(this.selectedValue == '中班'){
                    this.schoolData.gradeId = '3';
                }else if(this.selectedValue == '大班'){
                    this.schoolData.gradeId = '2';
                }else{
                    this.schoolData.gradeId = '1';
                }
            },

            nextStep:function(){
                var self = this;                 

                var classList=[];
                for(var i in self.classInfo.classSelected){
                    classList.push(self.classInfo.classSelected[i].id);
                }

                if(classList.length<=0 ){
                    modal.toast({
                        message:'请选择学校、班级、填写邀请码'
                    });
                    return;
                }

                var subData='';


                if(self.isJoinClass == 'no'){
                    subData = 'classList='+classList.join("#")+'&inviteCode='+self.schoolCode
                }else if(self.isJoinClass == 'yes'){
                    subData = 'classList='+classList.join("#")
                }

                //绑定班级（多个）
                Utils.fetch({
                    url:'/app/class/bind/'+self.schoolData.schoolId,
                    data:subData,
                    type:'json',
                    method:'POST',
                    success:function(ret){
                        if(ret.data.indexOf('200') != -1){
                            modal.toast({
                                message:'已成功加入班级',
                                duration:'1'
                            });

                             Utils.fetch({
                                url:'/app/class',
                                method:'get',
                                dataType:'json',
                                success:function(res){
                                    if(res.data.StatusCode == '200'){
                                        self.myClass = res.data.data;

                                        for(var i in res.data.data){
                                            res.data.data[i].imgUrl='';
                                            res.data.data[i].borderWidth='';
                                            res.data.data[i].borderStyle='';
                                            res.data.data[i].borderColor='';
                                            res.data.data[i].color = '';
                                        }
                                        storage.setItem('myClass',JSON.stringify(self.myClass),function(){});
                                    }
                                }
                            });

                            setTimeout(function(){
                                var url = Utils.setOpenUrl(self.$getConfig(),'index');
                                Utils.navigate.push(self,url,'true');
                            },1000);

                            storage.setItem('isJoinClass','yes',function(){});
                       }else{
                            modal.toast({
                                message:'加入班级失败，请检查邀请码是否正确',
                                duration:'2'
                            });
                       }
                    }
                });
            },
            chooseCity:function(){
                // var self = this;
                // if(self.isCityEmpty){
                //     self.isShowCity = true;
                // }else{
                //     self.isShowCity = false;
                // }                
                // self.address = self.location;

                var self = this;
                var url = Utils.setOpenUrl(self.$getConfig(),'city-picker');
                Utils.navigate.push(self,url,'true');

            },
            chooseSchool:function(){                
                var self = this;  

                if(self.countryId == '请选择地区'){
                    modal.alert({
                        message:self.countryId,
                        okTitle:'好的'
                    },function(){});
                    return;
                }

                Utils.fetch({
                    url:'/app/school?addr='+encodeURI(self.countryId),
                    method:'get',
                    dataType:'JSON',
                    success:function(res){  
                        res.data = eval('('+res.data+')');                     
                        if(res.data.StatusCode == '200'){
                            self.schoolList = res.data.data;                           
                        }
                    }
                }); 
                
                
                self.isShowSchools = !self.isShowSchools;
                // self.class = '请选择班级';
            },
            chooseClass:function(){
                var self = this; 

                if(self.isJoinClass == 'no'){
                    if(self.schoolData.schoolName == '请选择学校'){
                        modal.alert({
                            message:self.schoolData.schoolName,
                            okTitle:'好的'
                        },function(){});
                        return;
                    }
                }             

                Utils.fetch({
                    url:'/app/school/'+self.schoolData.schoolId+'/class',
                    dataType:'json',
                    method:'get',
                    success:function(ret){
                        self.showClass = 1;
                        
                        var data = ret.data;
                       
                        // if(data.StatusCode == '200'){
                            self.classList = data.data;
                            
                            //过滤掉已加入的班级，比較兩個對象數組，去重
                            if(self.myClass.length > 0){                                  
                                var result = [];
                                for(var i = 0; i < self.classList.length; i++){
                                    var obj = self.classList[i];
                                    var num = obj.id;
                                    var isExist = false;
                                    for(var j = 0; j < self.myClass.length; j++){
                                        var aj = self.myClass[j];
                                        var n = aj.id;
                                        if(n == num){
                                            isExist = true;
                                            break;
                                        }
                                    }
                                    if(!isExist){
                                        result.push(obj);
                                    }
                                }
                                self.classList = result;

                            }   


                            //班級類別轉換
                            for(var i=0;i<self.classList.length;i++){
                                if(self.classList[i].grade_id == '4'){
                                    self.classList[i].grade_id = '小班';
                                }else if(self.classList[i].grade_id == '3'){
                                    self.classList[i].grade_id = '中班';
                                }else if(self.classList[i].grade_id == '2'){
                                    self.classList[i].grade_id = '大班';
                                }else{
                                    self.classList[i].grade_id = '大大班';
                                }   

                                self.classList[i].imgUrl = self.images2.blankRadio;
                            }
                            
                            if(self.classInfo.classSelected.indexOf('请选择班级')==-1){
                                for(var i=0;i<self.class.length;i++){
                                    for(var j=0;j<self.classList.length;j++){
                                        if(self.class[i] == self.classList[j].class_name){
                                            self.classList[j].imgUrl = self.images2.selectRadio;
                                        }
                                    }
                                }
                            }

                            storage.setItem('classList',JSON.stringify(self.classList),function(){});
                        // }else{
                        //     modal.toast({
                        //         message:'网络故障，请稍后再试！',
                        //         duration:'1'
                        //     });
                        // }               
                    }
                });
            },
            radioCheck:function(index){
                var self =this;
                for(var i=0;i<self.schoolList;i++){                               
                    self.schoolList[i].isCheck = false; 
                    self.schoolList[index].isCheck = true;               
                }
                storage.setItem('schoolName',self.schoolList[index].name,function(){});
                storage.setItem('schoolId',self.schoolList[index].id,function(){});

                
                self.schoolData.schoolName = self.schoolList[index].name;
                self.schoolData.schoolId = self.schoolList[index].id;
                self.isShowSchools = 0; 
            },
            schoolCodeIn:function(e){
                var self = this;
                // self.schoolCode = '';
                self.schoolCode = e.value;
            },
            
        },
    }
</script>
