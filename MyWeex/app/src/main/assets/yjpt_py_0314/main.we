<template>
        <scroller class="content">
            <div style=" background-color: #f4f1f1; " >
                <img style="width: 750; height: 480; " src="{{lb}}">
                <div class="dwPic">
                    <div><image style="width: 247; height: 247; " src="{{bjUrl}}" ></image></div>
                    <div class="pic_bj" ><img class="pic_Photo" src="{{portrait}}" onclick='goProfile(myUrl)'></div>
                </div>
                <div class="item" style=" background-color: #fff;" >
                    <img-item-inside menu-list="{{menuList}}" ></img-item-inside>
                </div>
                <div class="nav_title">
                    <text class="title_name">班级群</text>
                </div>
                <div style="margin-bottom: 20px;z-index: 100;position: relative;background-color: #fff;">                   
                    <!-- <user-view-item data-list="{{dataList}}"></user-view-item>  -->
                    <!--班级群：--> 
                    <group-list></group-list>

                </div>
                <div style="position: fixed;right:10;top:30;"> 
                    <div style="padding-left: 50;padding-right: 10;padding-top: 30;padding-bottom: 30;"  onclick='toggleMenu'>
                        <img src="{{picAdd}}" class="more">                        
                    </div>                     
                    <div class="pop_menu" if='isShowMenu' style="z-index: 999999;">
                        <div class="menu">
                            <text class="menu_list" onclick='createGroup(chooseClass)'>发起群聊</text>
                            <text class="menu_list" onclick='joinClass()'>扫码加班</text>
                        </div>
                    </div>
                </div>

                <div class="class_list" if="{{isShowClass==1}}">
                    <div class="list_wrap">
                        <div class="list_title">
                            <text class="title">请选择班级</text> 
                            <text class="title"  onclick="toggleClass"> 取消</text>                         
                        </div>
                        <div style='max-height: 400px;overflow:scroll;'>
                            <text class="list_txt" repeat="{{classGroup}}" onclick="gotoPage(id)">{{name}}</text>
                        </div>                        
                    </div>
                </div>
            </div>
        </scroller>
</template>  
<style>
      .class_list{position: fixed;left: 0;right: 0;bottom: 0;top:0;background-color: rgba(0,0,0,.7);width: 750px;z-index: 9999;}
      .list_title{font-size: 36px;padding: 35;text-align: center;border-bottom-style: solid;border-bottom-color: #e7e7e7;border-bottom-width: 1px;background-color: #00cc99;color:#fff;text-align: center;position: relative;display: flex;flex-direction: row;justify-content: space-between;}
      .list_wrap{position: absolute;left: 0;right: 0;bottom: 0;background-color: #fff;}
      .list_txt{text-align: center;padding: 35;border-bottom-style: solid;border-bottom-color: #e7e7e7;border-bottom-width: 1px;}

      .title{font-size: 36px;color: #fff;text-align: left;}
      .content {
        color: #353535;
        background-color: #fff;
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        } 
        .item {
        flex-direction: row; flex-wrap:wrap; 
        border-color: #e7e7e7;
        border-width: 1;
        border-style: solid; 
       /* border-bottom-width: 0;*/
      }
      .pop_menu{position: absolute;top: 0;z-index:99999;right: -20;/*background-color: rgba(0,0,0,.6);*/}
        .menu{position: absolute;top: 60;right: 25;background-color: rgba(255,255,255,.7);border-radius: 4;flex-direction: column;width: 280;}
        .menu_list{flex:1;font-size: 34;color: #333;text-align: center;padding-top:40;padding-bottom:40;padding-left:30;padding-right:30;border-bottom-width: 1;border-bottom-color: #ccc;width: 280;font-family: Microsoft YaHei;}


      .item_img { flex-direction: row; flex-wrap:wrap; }
      .nav_title{flex-direction:row; width: 750; background-color:#f4f1f1; height: 90; display: flex; align-items: center; justify-content: space-between; padding-right:20;z-index: 999;overflow: visible;position: relative;}
      .title_name {color:#000000;  font-size:38; padding-left: 20; font-family:微软雅黑;}
      .more{ text-align:right; width: 70px; height: 70px; color:#b8b8b8;}
      .dwPic{width: 750; position: absolute; z-index: 999; top: 130;left:251;}
      .pic_bj{width:750; position: absolute; z-index: 999; top: 43; left: 43;}
      .pic_Photo{ width: 160px; height: 160px; border-style:solid; border-width: 2; border-color: #fff; border-radius: 80;}  

    
      
</style>

<script>
    require('weex-components');
    var Utils = require('./javascript/Utils');
    var storage = require('@weex-module/storage');
    var modal = require('@weex-module/modal');
    var event = require('@weex-module/event');
    module.exports = {
        data: {
            dir: 'yjpt',
            lb:'',
            bjUrl:'',
            portrait:'',
            picAdd:'',
            isShowMenu:false,
            myUrl:'wo',
            images:{
                mainGroup:'yjpt/images/Photo_04.png',
                otherGroup:'yjpt/images/Photo_05.png',
                radioBlank:'yjpt/images/blank_radio2.png',
                radioCheck:'yjpt/images/select_radio2.png',
            },
            menuList: [
              { pictureUrl: 'yjpt/images/pic_zt01.png',title: '我要上课',url:'class-attending'},
              { pictureUrl: 'yjpt/images/pic_zt02.png',title: '早教频道',url:'index_zjpd'},
              { pictureUrl: 'yjpt/images/pic_zt03.png',title: '照片发布',url:'wdxc_fbwz'}
            ],
            dataList: [
                {title: '小一班班群', pictureUrl: 'yjpt/images/Photo_04.png',state:5,news_content:'你家孩子最近上课开小差',date:'07/01',size:1,url:'chat-item',classId:'{{classId}}'},
                {title: '小一班班群', pictureUrl: 'yjpt/images/Photo_04.png',state:5,news_content:'你家孩子最近上课开小差',date:'07/01',size:1,url:'chat-item',classId:'{{classId}}'},
                {title: '小一班班群', pictureUrl: 'yjpt/images/Photo_04.png',state:5,news_content:'你家孩子最近上课开小差',date:'07/01',size:1,url:'chat-item',classId:'{{classId}}'},
                {title: '小一班讨论组', pictureUrl: 'yjpt/images/Photo_05.png',state:5,news_content:'明天带两个孩子出去',date:'01/11',size:1,url:'chat-item',classId:'{{classId}}'}
            ],
            classUrl:'class-list-default',
            chooseClass:'class-list',
            classGroup:[
                {
                    name:'',
                    lastUpdateTime:'07/11',
                    lastMsg:'你家孩子最近上课开小差你家孩子最近上课开小差',
                    lastMember:'pengyi',
                    msgNumber:'1'
                },
            ],
            otherGroup:[
                {
                    name:'家长们',
                    lastUpdateTime:'07/11',
                    lastMsg:'你家孩子最近上课开小差你家孩子最近上课开小差',
                    lastMember:'pengyi',
                    msgNumber:'1'
                },
            ],
            isShowClass:0,
            userId:'',
            requesToken:'',
            earlyEduUrl:'early-edu'
        },
        created: function() {
          this.lb = Utils.ip + 'yjpt/images/banner.png';
          this.bjUrl= Utils.ip + 'yjpt/images/Photo_bj.png';


          this.picAdd= Utils.ip + 'yjpt/images/add.png';
          // Utils.changeImg(this.menuList,['pictureUrl']);
          // Utils.changeImg(this.dataList,['pictureUrl']); 


          for(var i=0;i<this.menuList.length;i++){
              this.menuList[i].pictureUrl = Utils.ip + this.menuList[i].pictureUrl;
          }

          for(var i=0;i<this.dataList.length;i++){
              this.dataList[i].pictureUrl = Utils.ip + this.dataList[i].pictureUrl;
          }

          Utils.changeImg(this.images,['mainGroup','otherGroup']);
          Utils.changeImg(this.images,['radioBlank','radioCheck']);

          var self = this;

          self.earlyEduUrl = Utils.setOpenUrl(self.$getConfig(),self.earlyEduUrl);

          for (var i=0;i< this.menuList.length;i++) {
              self.menuList[i].url = Utils.setOpenUrl(self.$getConfig(),self.menuList[i].url);
          } 
          for (var i=0;i<this.dataList.length;i++) {
              self.dataList[i].url = Utils.setOpenUrl(self.$getConfig(),self.dataList[i].url);
          } 

          self.classUrl = Utils.setOpenUrl(self.$getConfig(),self.classUrl);
          self.chooseClass = Utils.setOpenUrl(self.$getConfig(),self.chooseClass);
          self.myUrl = Utils.setOpenUrl(self.$getConfig(),self.myUrl);          
          
          //设置头像
          storage.getItem('userInfo',function(e){
            e.data = JSON.parse(e.data);
              if(!e.data.avatar){
                  self.portrait = Utils.ip + 'yjpt/images/photo_06.jpeg';
              }else{
                self.portrait = Utils.ip +'yjpt'+ e.data;
              }
              self.userId = e.data.id;
          });

          
          // Utils.fetch({
          //     url:'/app/class',
          //     method:'get',
          //     dataType:'json',
          //     success:function(res){
          //         if(res.data.StatusCode == '200'){
          //             self.classGroup = res.data.data;
          //             for(var i in res.data.data){
          //                 res.data.data[i].imgUrl = self.images.radioBlank;
          //                 res.data.data[i].borderWidth='2px';
          //                 res.data.data[i].borderStyle='solid';
          //                 res.data.data[i].borderColor='#e7e7e7';
          //                 res.data.data[i].color = '#000000';
          //             }

          //             storage.setItem('myClass',JSON.stringify(res.data.data),function(){});

          //             //组装好classGroup\otherGroup 之后存到缓存中
          //             storage.setItem('classGroup',JSON.stringify(self.classGroup),function(){});
          //             storage.setItem('otherGroup',JSON.stringify(self.otherGroup),function(){});
          //         }
          //     }    
          // });

          self.$on('isShowClass',function(e){
              self.isShowClass = e.detail;
          }); 

          
        },
        methods: {

            redirect(url){
                //首页加入班级应该为扫码加班

                var self = this;
                self.isShowMenu = !self.isShowMenu;
                storage.getItem('myClass',function(e){
                    console.log(JSON.parse(e.data));
                });
                Utils.navigate.push(self,url,'true');
            },
            toggleMenu(){
                var self = this;
                self.isShowMenu = !self.isShowMenu;
            },
            goProfile(url){
                var self = this;
                Utils.navigate.push(self,url,'true');
            },
            createGroup(url){
                var self = this;
                self.isShowMenu = !self.isShowMenu;
                Utils.navigate.push(self,url,'true');
            },
            toggleClass(){
                var self = this;
                self.isShowClass = 0;
            },
            gotoPage(classId){
                var self = this;

                Utils.fetch({
                    url:'/V1/Oauth/createToken',
                    method:'post',
                    data:'appKey=e9a64ef49283dd53&userId='+self.userId+'&platformKey=kiway&classId='+classId,
                    dataType:'json',
                    success:function(res){
                        if(res.data.returnCode == '200'){
                            self.requesToken = res.data.returnData.token;
                            storage.setItem('requesToken',self.requesToken,function(){});

                            Utils.navigate.push(self,self.earlyEduUrl,'true');
                        }else{
                            modal.toast({
                                message:'操作失败，请稍后重试',
                                duration:'1'
                            });
                        }
                    }
                });
            },
            joinClass(){
                var self = this;
                self.isShowMenu = !self.isShowMenu;
                var classInfo = {};
                if(event.AddClass ){
                    event.AddClass('1',function(res){
                      //返回classId,再加入该班级
                        if(res.result == 1){                            
                            Utils.fetch({
                                url:'/app/class/bind/'+res.schoolId,
                                data:'classList=' +res.classId,
                                method:'POST',
                                dataType:'json',
                                success:function(ret){
                                    if(ret.data.StatusCode == '200'){
                                        classInfo.id = res.classId;
                                        classInfo.name = res.className;
                                        classInfo.schoolId = res.schoolId;
                                        storage.setItem('classInfo',JSON.stringify(classInfo),function(){});
                                        
                                        var url = Utils.setOpenUrl(self.$getConfig(),'class-main-page');
                                        Utils.navigate.push(self,url,'true');
                                    }else{
                                        modal.toast({
                                            message:'操作失败，请稍后重试'
                                        });
                                    }
                                }
                            });
                        }else{
                            modal.alert({
                                message:'请求失败'
                            },function(){});
                        }
                    });
                }else{
                    modal.toast({
                      message:'请在App中操作'
                    });
                }
            }
        }
    }
</script>


